# 구현 계획

- [ ] 1. 날짜 인식 AI 컨텍스트 구현
  - 모든 Gemini API 요청에 대해 현재 KST 날짜 계산 및 시스템 프롬프트 주입 추가
  - 날짜 인식 지침으로 시스템 프롬프트 파일 업데이트
  - _요구사항: 1.1, 1.2, 1.3, 1.4, 1.5_

- [ ] 1.1 KST 날짜 계산 유틸리티 추가
  - YYYY-MM-DD 형식을 반환하는 getCurrentKSTDate() 헬퍼 함수 생성
  - UTC에 9시간 오프셋을 추가하여 KST 시간 계산
  - AssistanceService 클래스에 함수 추가
  - _요구사항: 1.1, 1.4_

- [ ] 1.2 시스템 프롬프트에 현재 날짜 주입
  - getGeminiResponse()를 수정하여 getCurrentKSTDate() 호출
  - 현재 날짜와 함께 시스템 프롬프트에 [CURRENT_DATE] 섹션 추가
  - AI가 상대 날짜 계산에 이 날짜를 사용하도록 지침 포함
  - _요구사항: 1.2, 1.3, 1.5_

- [ ] 1.3 날짜 인식 규칙으로 시스템 프롬프트 파일 업데이트
  - assistance.systemPrompt.txt에 [DATE_AWARENESS] 섹션 추가
  - "오늘", "내일", 모호한 날짜 처리 지침 포함
  - 연도 없는 날짜 해석 가이드 추가
  - _요구사항: 1.2, 1.3, 1.5_

- [ ]* 1.4 날짜 인식 기능 테스트
  - getCurrentKSTDate()가 올바른 형식을 반환하는지 테스트
  - 프롬프트에 날짜 컨텍스트 주입 테스트
  - AI가 "오늘", "내일", "11월 14일"을 올바르게 해석하는지 테스트
  - 현재 연도로 모호한 날짜 해석 테스트
  - _요구사항: 1.1, 1.2, 1.3, 1.4, 1.5_

- [ ] 2. 콘텐츠 기반 할 일 업데이트 구현
  - 제목으로 할 일을 검색하는 findTodoByContent() 메서드 생성
  - ID 기반 및 콘텐츠 기반 업데이트를 모두 지원하도록 updateTodo() 향상
  - todoContentToFind 매개변수를 포함하도록 updateTodo 도구 정의 업데이트
  - _요구사항: 2.1, 2.2, 2.3, 2.4, 2.5_

- [ ] 2.1 findTodoByContent() 메서드 생성
  - 사용자의 할 일을 사용하여 대소문자 구분 없는 콘텐츠 검색 구현
  - 단일 일치에 대해 todoSeq와 함께 성공 반환
  - 여러 일치에 대해 일치 개수와 함께 오류 반환
  - 일치 항목 없음에 대해 오류 반환
  - _요구사항: 2.1, 2.2, 2.3, 2.4_

- [ ] 2.2 콘텐츠 기반 검색을 위한 updateTodo() 메서드 향상
  - todoContentToFind 선택적 매개변수 추가
  - todoSeq가 제공되지 않을 때 findTodoByContent() 호출
  - 업데이트 작업에 찾은 todoSeq 사용
  - 검색 실패에 대한 적절한 오류 반환
  - _요구사항: 2.1, 2.2, 2.3, 2.4, 2.5_

- [ ] 2.3 updateTodo 도구 정의 업데이트
  - 도구 정의에 todoContentToFind 매개변수 추가
  - completeDtm 매개변수를 isCompleted boolean 매개변수로 교체
  - ID 및 콘텐츠 기반 업데이트를 모두 설명하도록 설명 업데이트
  - todoSeq와 todoContentToFind가 모두 선택 사항이지만 하나는 필수임을 보장
  - _요구사항: 2.1, 2.5, 2.6, 2.7, 2.8, 2.9_

- [ ] 2.4 콘텐츠 기반 업데이트 지침으로 시스템 프롬프트 업데이트
  - assistance.systemPrompt.txt에 [CONTENT_BASED_UPDATES] 섹션 추가
  - todoContentToFind 매개변수 사용 가이드 포함
  - 여러 일치 처리 지침 추가
  - _요구사항: 2.2, 2.3_

- [ ]* 2.5 콘텐츠 기반 업데이트 기능 테스트
  - 정확한 콘텐츠 일치가 올바른 할 일을 찾는지 테스트
  - 부분 일치 테스트 (대소문자 구분 없음)
  - 여러 일치가 개수와 함께 오류를 반환하는지 테스트
  - 일치 항목 없음이 적절한 오류를 반환하는지 테스트
  - 검색 쿼리의 특수 문자 테스트
  - 엔드투엔드 테스트: "'우유 사기' 작업 업데이트"
  - isCompleted: true가 completeDtm을 현재 타임스탬프로 설정하는지 테스트
  - isCompleted: false가 completeDtm을 NULL로 설정하는지 테스트
  - isCompleted: undefined가 completeDtm을 변경하지 않는지 테스트
  - _요구사항: 2.1, 2.2, 2.3, 2.4, 2.5, 2.6, 2.7, 2.8, 2.9_

- [ ] 3. 쓰기 작업 후 사전 목록 새로고침 구현
  - 새로고침된 할 일 목록을 자동으로 가져와 반환하도록 createTodo() 향상
  - 새로고침된 할 일 목록을 자동으로 가져와 반환하도록 updateTodo() 향상
  - 새로고침된 목록을 표시하도록 AI에게 지시하는 시스템 프롬프트 업데이트
  - _요구사항: 3.1, 3.2, 3.3, 3.4, 3.5_

- [ ] 3.1 createTodo() 메서드에 자동 새로고침 추가
  - 성공적인 할 일 생성 후 getTodos() 호출
  - 반환 객체에 refreshedList 포함
  - 새로고침된 목록에 ±7일 범위 사용
  - _요구사항: 3.1, 3.5_

- [ ] 3.2 updateTodo() 메서드에 자동 새로고침 추가
  - 성공적인 할 일 업데이트 후 getTodos() 호출
  - 반환 객체에 refreshedList 포함
  - 새로고침된 목록에 ±7일 범위 사용
  - _요구사항: 3.2, 3.5_

- [ ] 3.3 사전 새로고침 지침으로 시스템 프롬프트 업데이트
  - assistance.systemPrompt.txt에 [PROACTIVE_REFRESH] 섹션 추가
  - [FORMATTING_RULES]를 사용하여 refreshedList를 표시하도록 AI에게 지시
  - 확인 + 목록이 포함된 예시 응답 형식 제공
  - _요구사항: 3.3, 3.4_

- [ ]* 3.4 사전 새로고침 기능 테스트
  - createTodo가 refreshedList를 반환하는지 테스트
  - updateTodo가 refreshedList를 반환하는지 테스트
  - refreshedList에 관련 할 일(±7일)이 포함되는지 테스트
  - refreshedList 형식이 getTodos 형식과 일치하는지 테스트
  - 엔드투엔드 테스트: 작업 생성 → 확인 + 목록 표시
  - 엔드투엔드 테스트: 작업 완료 → 확인 + 목록 표시
  - _요구사항: 3.1, 3.2, 3.3, 3.4, 3.5_

- [ ] 4. 세션 기반 보안 확인 및 강화
  - userSeq가 세션에서 오는지 확인하기 위해 모든 함수 메서드 감사
  - 도구 정의에 userSeq 매개변수가 포함되지 않았는지 확인
  - TodoService 메서드가 userSeq로 필터링하는지 확인
  - 업데이트 작업에 소유권 확인 추가
  - _요구사항: 4.1, 4.2, 4.3, 4.4, 4.5, 4.6, 4.7_

- [ ] 4.1 세션 userSeq 사용에 대한 getGeminiResponse() 감사
  - userSeq 매개변수가 ChatController 세션에서 오는지 확인
  - userSeq가 모든 함수 호출(getTodos, createTodo, updateTodo)에 전달되는지 확인
  - AI가 userSeq를 지정할 수 있는 코드 경로가 없는지 확인
  - _요구사항: 4.1, 4.2, 4.3, 4.4_

- [ ] 4.2 도구 정의에서 userSeq 제외 확인
  - getTodosTool 정의 검토 - userSeq 매개변수가 없는지 확인
  - createTodoTool 정의 검토 - userSeq 매개변수가 없는지 확인
  - updateTodoTool 정의 검토 - userSeq 매개변수가 없는지 확인
  - _요구사항: 4.7_

- [ ] 4.3 TodoService 메서드가 userSeq로 필터링하는지 확인
  - TodoService.findAll() 검토 - userSeq 필터 확인
  - TodoService.create() 검토 - userSeq가 세션 사용자에서 설정되는지 확인
  - TodoService.update() 검토 - 소유권 확인 보장
  - 없는 경우 명시적 소유권 확인 추가
  - _요구사항: 4.5, 4.6_

- [ ]* 4.4 보안 강화 테스트
  - userSeq가 항상 세션에서 오고 AI에서 오지 않는지 테스트
  - 도구 정의에 userSeq 매개변수가 없는지 테스트
  - TodoService 메서드가 userSeq로 필터링하는지 테스트
  - 업데이트 작업이 소유권을 확인하는지 테스트
  - 교차 사용자 접근 시도가 차단되는지 테스트
  - 무단 접근이 404를 반환하는지 테스트 (403이 아님)
  - _요구사항: 4.1, 4.2, 4.3, 4.4, 4.5, 4.6, 4.7_

- [ ] 5. 통합 테스트 및 검증
  - 네 가지 향상 사항이 모두 함께 작동하는지 테스트
  - 기존 AI 어시스턴트 기능에 회귀가 없는지 확인
  - 오류 처리 및 엣지 케이스 테스트
  - _요구사항: 1.1-1.5, 2.1-2.5, 3.1-3.5, 4.1-4.7_

- [ ]* 5.1 엔드투엔드 통합 테스트
  - 테스트: "내일 작업 생성" → 올바른 날짜 + 새로고침된 목록
  - 테스트: "'우유 사기' 업데이트하고 완료 표시" → 콘텐츠 검색 + 업데이트 + 목록
  - 테스트: "지연된 작업 보여줘" → 날짜 인식 쿼리
  - 테스트: 모호한 콘텐츠 일치 → AI가 명확히 요청
  - 테스트: 순차적으로 여러 쓰기 작업
  - _요구사항: 1.1-1.5, 2.1-2.5, 3.1-3.5_

- [ ]* 5.2 오류 처리 및 엣지 케이스 테스트
  - 테스트: 잘못된 날짜 형식
  - 테스트: 특수 문자가 있는 콘텐츠 검색
  - 테스트: 빈 할 일 목록 새로고침
  - 테스트: 작업 중 세션 만료
  - 테스트: 동시 쓰기 작업
  - _요구사항: 1.1-1.5, 2.1-2.5, 3.1-3.5, 4.1-4.7_

- [ ]* 5.3 회귀 테스트
  - 테스트: 기존 ID 기반 업데이트가 여전히 작동하는지
  - 테스트: 기존 getTodos 기능이 변경되지 않았는지
  - 테스트: AI가 여전히 할 일 관련 없는 요청을 거부하는지
  - 테스트: 형식 규칙이 여전히 올바르게 적용되는지
  - 테스트: 오류 메시지가 여전히 한국어인지
  - _요구사항: 1.1-1.5, 2.1-2.5, 3.1-3.5, 4.1-4.7_
